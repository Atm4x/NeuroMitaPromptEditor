
# Конструктор промптов (DSL)

---

## 1. Зачем это всё

* **Основная идея:** писать тексты «кирпичиками», а конструктор склеит их
  в одну строку.  
* **Что умеет:**
  1. Подставлять другие файлы с помощью простых скобок.  
  2. Выполнять небольшие скрипты, чтобы менять текст в зависимости от
     переменных.  
  3. Вставлять заранее подготовленную информацию (`{{SYS_INFO}}`
     и подобные метки).

---

## 2. Какие бывают файлы

| Расширение | Для чего нужен                                                  |
|------------|-----------------------------------------------------------------|
| **`*.txt`**    | Обычный текст. Может включать другие файлы и секции. |
| **`*.script`** | Мини-скрипт. При запуске возвращает строку.                 |

---

## 3. Как собирается финальный текст

1. Всё начинается с файла `main_template.txt` персонажа.  
2. Внутри него встречаются **плейсхолдеры** — специальные скобки  
   `[< путь/к/файлу >]`.  
3. Если путь указывает на `.txt`, содержимое файла вставляется «как есть».  
4. Если путь указывает на `.script`, скрипт выполняется.  
   Что он вернёт — то и подставится.  
5. После этого конструктор заменяет метки вида `{{SYS_INFO}}` на их
   значения.  
6. Готовый текст отправляется в модель.

---

## 4. Плейсхолдеры `[< … >]`

```
[<Main/common.txt>]          # вставит обычный текст
[<Scripts/build_mood.script>]# выполнит скрипт и подставит результат
```

*Путь пишут относительно текущего файла, либо c `../`, либо из
общих папок `_CommonPrompts/`, `_CommonScripts/`.*

---

## 5. Вставки `{{…}}`

```
{{SYS_INFO}}
{{PLAYER_NAME}}
```

Значения задаёт программист из Python:

```python
interp.set_insert("PLAYER_NAME", "Алиса")
```

---

## 6. Секции внутри `.txt`

Иногда один файл содержит несколько независимых кусков.  
Тогда его делят вот так:

```text
[#GREETING]
Привет, путник!
[/GREETING]

[#FAREWELL]
До встречи.
[/FAREWELL]
```

Скрипт может забрать нужную секцию:

```dsl
RETURN LOAD GREETING FROM "Main/phrases.txt"
```

Если нужен **весь** файл целиком — используйте

```dsl
RETURN LOAD "Main/phrases.txt"   # маркеры [#…] /[/…] будут убраны
```

---

## 7. Мини-скрипты (`*.script`)

### 7.1 Команды

| Команда                                        | Что делает                          |
|------------------------------------------------|-------------------------------------|
| `SET имя = выражение`                          | Сохраняет значение в переменную.    |
| `LOG выражение`                                | Пишет в лог — удобно для отладки.   |
| `IF / ELSEIF / ELSE / ENDIF`                   | Обычное ветвление.                  |
| `RETURN …`                                     | Завершает скрипт и отдаёт строку.   |

### 7.2 `RETURN` умеет

* `RETURN "Просто строка"`  
* `RETURN LOAD "Main/core.txt"`  
* `RETURN LOAD GREETING FROM "Main/phrases.txt"`  
* Арифметику и конкатенацию:  
  `RETURN LOAD A FROM "file.txt" + "\n" + LOAD B FROM "file.txt"`

### 7.3 Пример скрипта

```dsl
// показать разный текст по настроению
IF mood > 70
    RETURN "Настроение отличное!"
ELSE
    RETURN "Настроение так себе…"
ENDIF
```

---

## 8. Мини-пример проекта

```
Prompts/
└── Hero/
    ├── main_template.txt
    ├── Main/
    │   └── hero_core.txt
    ├── Scripts/
    │   └── build_mood.script
```

### main_template.txt

```text
[<Main/hero_core.txt>]

Current mood:
[<Scripts/build_mood.script>]

{{SYS_INFO}}
```

### build_mood.script

```dsl
IF bravery > 50
    RETURN "Fearless"
ELSE
    RETURN "Cautious"
ENDIF
```

---

## 9. Советы промптеру

1. **Разбивайте** большие тексты на мелкие `.txt`.  
2. **Логи (`LOG`)** помогают понять, что происходит в скрипте.  
3. Старайтесь держать переменные и логику в `.script`, а тексты — в
   `.txt`.  
4. Общее для всех персонажей кладите в `_CommonPrompts` или
   `_CommonScripts`.  
5. Не забывайте про `{{SYS_INFO}}`, если он нужен системе.

---