# Конструктор промптов (DSL)

Доки сгенерены, так что если что-то непонятно — пишите

---

## 1. Зачем это всё

* **Идея:** писать текст кусочками («кирпичиками»), а конструктор склеит
  их в одну строку.
* **Что умеет:**
  1. Подставлять файлы через простые скобки `[<…>]`.
  2. Запускать скрипты и менять текст в зависимости от переменных.
  3. Вставлять заранее подготовленную информацию — `{{SysInfo}}`
     и другие вставки.

---

## 2. Какие бывают файлы

| Расширение | Для чего нужен                                          |
|------------|---------------------------------------------------------|
| `*.txt`    | Обычный текст. Может включать другие файлы и секции.    |
| `*.script` | Скрипт. Запускается, возвращает строку (командой `RETURN`). |

---

## 3. Как собирается финальный текст

1. Стартовый файл — **`main_template.txt`** персонажа.  
2. В нём встречаются плейсхолдеры `[<…>]`.  
3. Если путь указывает на `.txt`, файл вставляется «как есть».  
4. Если путь указывает на `.script`, скрипт выполняется;
   его строка-результат подставляется.  
5. Затем меняются все вставки `{{…}}` на свои значения.  
6. Готовый текст отправляется в LLM.

---

## 4. Плейсхолдеры `[< … >]`

```text
[<Main/common.txt>]            # вставит текст
[<Scripts/build_mood.script>]  # выполнит скрипт и подставит строку
```

Путь пишется:

* относительно текущего файла `./…`
* на уровень выше `../…`
* из общих папок `_CommonPrompts/`, `_CommonScripts/`.

---

## 5. Вставки `{{ … }}`

```text
{{SysInfo}}
{{PlayerName}}
```

Значение задаётся в Python:

```python
interp.set_insert("PlayerName", "Алиса")
```

---

## 6. Секции в `.txt`

```text
[#Greeting]
Привет, путник!
[/Greeting]

[#Farewell]
До встречи.
[/Farewell]
```

* Взять конкретную секцию:  
  ```dsl
  RETURN LOAD Greeting FROM "Main/phrases.txt"
  ```
* Взять весь файл (маркеры секций будут убраны):  
  ```dsl
  RETURN LOAD "Main/phrases.txt"
  ```

---

## 7. Скрипты (`*.script`)

### 7.1 Полный список команд

| Команда                    | Назначение                               |
|----------------------------|------------------------------------------|
| `SET var = expr`           | Записать значение.                      |
| `LOG expr`                 | Вывести в лог (для отладки).            |
| `IF / ELSEIF / ELSE / ENDIF` | Условные блоки.                       |
| `RETURN …`                 | Завершить скрипт и вернуть строку.      |

### 7.2 Что может стоять после `RETURN`

| Запись                               | Что вернётся (пример)                                       |
|--------------------------------------|-------------------------------------------------------------|
| `RETURN "Просто строка"`             | `Просто строка`                                             |
| `RETURN LOAD "Main/core.txt"`        | содержимое `core.txt`                                       |
| `RETURN LOAD Greeting FROM "Main/phrases.txt"` | `Привет, путник!` (содержимое секции `Greeting`) |
| `RETURN LOAD A FROM "a.txt" + LOAD B FROM "b.txt"` | склейка: содержимое секции `A` + содержимое секции `B` |

### 7.3 Мини-пример скрипта

```dsl
// разный текст в зависимости от настроения
IF mood > 70 THEN
    RETURN "Настроение отличное!"
ELSE
    RETURN "Настроение так себе…"
ENDIF
```

---

## 8. Мини-проект (структура)

```
Prompts/
└── Hero/
    ├── main_template.txt
    ├── Main/
    │   └── hero_core.txt
    └── Scripts/
        └── build_mood.script
```

### main_template.txt

```text
[<Main/hero_core.txt>]

Current mood:
[<Scripts/build_mood.script>]

{{SysInfo}}
```

### build_mood.script

```dsl
IF bravery > 50 THEN
    RETURN "Fearless"
ELSE
    RETURN "Cautious"
ENDIF
```

**Результат** (если bravery = 80):

```
(содержимое hero_core.txt)

Current mood:
Fearless

<текст вместо {{SysInfo}}>
```

---

## 9. Советы
1. `LOG` поможет понять, почему скрипт выбрал ту или иную ветку.  
2. Держите логику в `.script`, тексты — в `.txt`.  
3. Общие материалы кладите в `_CommonPrompts` / `_CommonScripts`.  
