- описание сгенерено, так что за подробностями пишите -

## Руководство по Созданию Промптов с Использованием DSL

### I. Введение

Данное руководство предназначено для разработчиков промптов (промптеров) и описывает принципы работы с нашим специализированным языком DSL (Domain Specific Language). DSL позволяет создавать динамические, структурированные и управляемые текстовые промпты для персонажей. С его помощью вы можете использовать переменные, условную логику, подключать внешние текстовые блоки и скрипты, что делает процесс создания и поддержки сложных промптов более гибким и эффективным.

**Цель DSL:** Автоматизация и упрощение процесса генерации конечного текста промпта на основе набора правил, переменных и внешних файлов.

### II. Ключевые Концепции

Прежде чем приступить к написанию промптов, важно понять несколько основных концепций:

1.  **Типы Файлов:**
    *   **`.txt` файлы (Текстовые Шаблоны):**
        *   **Назначение:** Содержат преимущественно статический текст, который может включать в себя плейсхолдеры для вставки другого контента (из других `.txt` файлов или результатов работы `.script` файлов).
        *   **Пример из "Crazy":** `Prompts\Crazy\Main\common.txt` содержит общие инструкции по поведению, а `Prompts\Crazy\Context\examplesLong.txt` — примеры фраз.
    *   **`.script` файлы (Файлы Логики):**
        *   **Назначение:** Содержат команды DSL, которые выполняют логические операции, управляют переменными, условно включают или генерируют текстовые блоки. Результатом работы `.script` файла обычно является строка текста (или пустая строка), которая затем вставляется в место его вызова.
        *   **Пример из "Crazy":** `Prompts\Crazy\Scripts\personality_selector.script` на основе переменных решает, какой основной текстовый блок личности загрузить (`mainCrazy.txt`, `mainPlaying.txt` или `main.txt`).

2.  **`main_template.txt` (Главный Шаблон Персонажа):**
    *   **Назначение:** Это основной "входной" файл для каждого персонажа. Система начинает обработку промпта именно с него. Он определяет общую структуру финального промпта, подключая другие `.txt` и `.script` файлы.
    *   **Расположение:** Обычно находится в корневой папке персонажа (например, `Prompts\Crazy\main_template.txt`).

3.  **Переменные Персонажа:**
    *   **Назначение:** Хранят состояния, атрибуты или любую другую динамическую информацию о персонаже (например, `attitude`, `boredom`, `secretExposed`).
    *   **Управление:** Начальные значения переменных для тестирования в редакторе задаются на панели "Параметры DSL". В реальной системе они могут управляться внешним кодом.
    *   **Использование:** Доступны внутри `.script` файлов для принятия решений и формирования вывода.

4.  **Плейсхолдеры (Включения Файлов):**
    *   **Синтаксис:** `[<путь/к/файлу.txt_или_script>]`
    *   **Назначение:** Позволяют вставлять содержимое одного файла (или результат работы скрипта) в другой. Это основной механизм для построения модульных и переиспользуемых промптов.
    *   **Обработка:**
        *   Если плейсхолдер указывает на `.txt` файл, его содержимое читается и вставляется "как есть". Этот вставленный текст также может содержать свои плейсхолдеры.
        *   Если плейсхолдер указывает на `.script` файл, этот скрипт выполняется, и его возвращаемое значение (строка) вставляется на место плейсхолдера.
    *   **Пример из "Crazy" (`main_template.txt`):**
        *   `[<Structural/response_structure.txt>]`: Включает содержимое файла `response_structure.txt`, который описывает формат ответа.
        *   `[<Scripts/personality_selector.script>]`: Выполняет скрипт `personality_selector.script`, и результат его работы (путь к файлу личности, который затем загружается командой `RETURN LOAD` внутри скрипта) вставляется в промпт.

5.  **Теги:**
    *   **Синтаксис:** `{{ИМЯ_ТЕГА}}` (например, `{{SYS_INFO}}`).
    *   **Назначение:** Служат для вставки специфической информации, которая обычно определяется системой или контекстом выполнения промпта на более высоком уровне (вне DSL-логики).
    *   **`{{SYS_INFO}}`:** Зарезервирован для системной информации. **Важно:** В текущей версии редактора при нажатии "Скомпоновать промпт" тег `{{SYS_INFO}}` заменяется на **статический тестовый пример** (список строк). В полноценной интеграции его содержимое будет динамически формироваться вызывающей системой.

6.  **Пути к Файлам:**
    *   **Разрешение:** Система ищет файлы по указанным путям в определенном порядке:
        1.  **Общие каталоги:** Если путь начинается с `_CommonPrompts/` или `_CommonScripts/` (например, `[<../Common/Dialogue.txt>]` из `main_template.txt` персонажа "Crazy" обратится к `Prompts/Common/Dialogue.txt`), он ищется относительно корневой папки всех промптов (`Prompts/`).
        2.  **Относительно текущего файла:**
            *   `./имя_файла`: Файл в той же папке, что и текущий обрабатываемый файл.
            *   `../имя_файла`: Файл в родительской папке. (Нельзя выйти за пределы корневой папки `Prompts/`).
        3.  **Относительно базовой папки персонажа:** Если путь не соответствует п.1 или п.2 (например, просто `Main/common.txt` в `main_template.txt` персонажа "Crazy"), он ищется в папке текущего персонажа (`Prompts/Crazy/Main/common.txt`).

### III. Написание DSL-Скриптов (`.script` файлы)

Файлы `.script` являются сердцем динамической генерации промптов.

1.  **Основные Правила Синтаксиса:**
    *   **Комментарии:** Строки, начинающиеся с `//`, игнорируются.
        ```dsl
        // Это важная переменная
        SET mood = "happy" // Устанавливаем настроение
        ```
    *   **Регистр Команд:** Команды DSL нечувствительны к регистру (`SET` то же самое, что `set`). Однако рекомендуется использовать `UPPERCASE` для единообразия.
    *   **Выражения:** Используются для вычисления значений.
        *   **Арифметика:** `+`, `-`, `*`, `/`.
        *   **Сравнения:** `>`, `<`, `>=`, `<=`, `==` (равно), `!=` (не равно).
        *   **Логические операторы:** `AND`, `OR` (в условиях). `NOT` (пока не реализован напрямую, используйте сравнения `== FALSE`).
        *   **Строки:** В одинарных (`'текст'`) или двойных (`"текст"`) кавычках.
        *   **f-строки (форматированные строки):** `f"Имя: {player_name}, Очки: {score}"`. Позволяют вставлять значения переменных прямо в строку.
        *   **Булевы значения:** `TRUE`, `FALSE`.
        *   **Специальное значение:** `NONE`.
        *   **Преобразование типов:** Для конкатенации строк с числами используйте `str()`: `"Очки: " + str(score)`.
    *   **Многострочные Строки:** Для определения текстовых блоков, занимающих несколько строк, используйте тройные кавычки `""" ... """`.
        ```dsl
        SET long_text = """Это первая строка.
        Это вторая строка."""
        RETURN """Этот блок текста
        будет возвращен из скрипта."""
        ```

2.  **Команды DSL:**

    *   **`SET <имя_переменной> = <выражение>`**
        Присваивает результат вычисления `<выражения>` указанной `<имени_переменной>`.
        ```dsl
        SET playerScore = 100
        SET greetingMessage = "Привет, " + playerName + "!"
        SET isUserActive = TRUE
        // Пример из Prompts\Crazy\Scripts\context_info.script
        SET result_string = "Время: " + formatted_time + "."
        SET LongMemoryRememberCount = current_lm_count
        ```

    *   **`LOG <выражение>`**
        Выводит значение `<выражения>` в лог-файл (`Logs/dsl_execution.log`) и в панель логов редактора. Используется для отладки.
        ```dsl
        LOG "Текущее значение attitude: " + attitude
        LOG playerScore
        // Пример из Prompts\Crazy\Scripts\personality_selector.script
        LOG "PersonalitySelector: Script started. attitude=" + attitude + ", secretExposed=" + secretExposed
        ```

    *   **`IF <условие> [THEN]`**
        **`ELSEIF <условие> [THEN]`**
        **`ELSE`**
        **`ENDIF`**
        Обеспечивает условное выполнение блоков кода. Ключевое слово `THEN` опционально.
        ```dsl
        IF score > 50 THEN
            LOG "Отличный результат!"
            SET status_message = "Победа"
        ELSEIF score > 20
            LOG "Неплохо."
            SET status_message = "Можно лучше"
        ELSE
            LOG "Нужно стараться больше."
            SET status_message = "Попробуй еще"
        ENDIF

        // Пример из Prompts\Crazy\Scripts\personality_selector.script
        IF (attitude <= 10 OR secretExposed == True) THEN
            // ... логика для "Crazy" режима ...
            RETURN LOAD "Main/mainCrazy.txt" // Важно! Загружает файл и возвращает его содержимое
        ENDIF
        ```

    *   **`RETURN <выражение | LOAD "путь/к/файлу.txt" | LOAD_REL "путь/к/файлу.txt">`**
        Завершает выполнение текущего `.script` файла и возвращает указанное значение. Это значение будет вставлено в место вызова скрипта (плейсхолдера).
        *   **`RETURN <выражение>`**: Возвращает результат вычисленного выражения (строку, число и т.д., которое будет преобразовано в строку).
            ```dsl
            RETURN "Сообщение из скрипта."
            RETURN "Итого: " + str(totalScore)
            ```
        *   **`RETURN LOAD "путь/к/файлу.txt"`**: Загружает содержимое указанного текстового файла и возвращает его как одну строку. Пути разрешаются согласно правилам (см. Раздел II, п.6).
            ```dsl
            // Пример из Prompts\Crazy\Scripts\personality_selector.script:
            // Если условие выполнено, скрипт загрузит содержимое mainCrazy.txt
            // и вернет его. Это содержимое будет вставлено в main_template.txt
            // на место плейсхолдера [<Scripts/personality_selector.script>].
            IF secretExposed == True THEN
                RETURN LOAD "Main/mainCrazy.txt"
            ENDIF
            ```
        *   **`RETURN LOAD_REL "путь/к/файлу.txt"`**: Исторически существовала для явного указания относительного пути. В текущей реализации `LOAD` и `LOAD_REL` функционально идентичны при использовании внутри скриптов. Рекомендуется единообразно использовать `LOAD`.

        **Важно:** Если `.script` файл завершается без явной команды `RETURN`, он неявно возвращает пустую строку.

### IV. Работа с Текстовыми Шаблонами (`.txt` файлы)

Файлы `.txt` служат для хранения текстовых блоков, которые могут быть как статическими, так и включать динамические части через плейсхолдеры.

*   **Основное назначение:** Определение фрагментов промпта, описаний, примеров диалогов, инструкций и т.д.
*   **Использование плейсхолдеров:** Любой `.txt` файл может содержать плейсхолдеры `[<...>]` для включения:
    *   Содержимого других `.txt` файлов (например, общих инструкций, примеров).
    *   Результатов выполнения `.script` файлов (например, динамически сгенерированных списков доступных действий или описаний на основе переменных).
*   **Пример из "Crazy":**
    *   Файл `Prompts\Crazy\Main\common.txt` содержит общие инструкции по поведению и включает плейсхолдеры для динамического получения списков:
        ```text
        Тебе доступны лицевые эмоции, применяй их. Список доступных эмоций:
        [<Scripts/get_available_emotions.script>] // Скрипт вернет список эмоций

        Тебе доступны анимации (языка тела). Список доступных анимаций:
        [<Scripts/get_available_animations.script>] // Скрипт вернет список анимаций
        ```
    *   В данном случае, `get_available_emotions.script` и `get_available_animations.script` выполнят свою логику (возможно, на основе переменной `attitude`) и через `RETURN` передадут текстовый список, который будет вставлен в `common.txt`.

### V. Структура Папок Персонажа (на примере "Crazy")

Правильная организация файлов значительно упрощает разработку и поддержку промптов. Рассмотрим структуру персонажа "Crazy":

*   **`Prompts/`**: Корневая директория для всех персонажей и общих файлов.
    *   **`Common/`**: Содержит файлы, общие для нескольких персонажей.
        *   `Dialogue.txt`: Общие правила ведения диалога.
    *   **`Crazy/`**: Корневая папка для персонажа "Crazy".
        *   **`main_template.txt`**: Главный файл, собирающий весь промпт для "Crazy".
            ```text
            [<Structural/response_structure.txt>] // Подключает описание структуры ответа

            // -- Подключение общего файла диалога --
            [<../Common/Dialogue.txt>] // Использует относительный путь для выхода из 'Crazy' в 'Common'

            [<Scripts/get_variable_effects_description.script>] // Описание влияния переменных
            [<Scripts/initialize_character.script>]           // Скрипт инициализации (может быть пустым, если инициализация в Python)
            [<Scripts/personality_selector.script>]           // Ключевой скрипт, выбирающий "личность"
            [<Main/player.txt>]                             // Описание игрока, с которым общается Мита
            [<Scripts/example_selector.script>]               // Выбирает примеры диалогов (обычные/безумные)
            [<Scripts/history_loader.script>]                 // Загружает историю персонажа
            [<Scripts/event_handler.script>]                  // Обрабатывает специфические события (например, раскрытие секрета)
            [<Scripts/context_info.script>]                   // Генерирует контекстную информацию (время, счетчики памяти)
            [<Main/common.txt>]                             // Общие инструкции по поведению для "Crazy"
            [<Scripts/fsm_handler.script>]                    // Обработчик состояний (FSM - Finite State Machine)
            ```
        *   **`Context/`**: Файлы, предоставляющие контекстную информацию, примеры.
            *   `examplesLong.txt`, `examplesLongCrazy.txt`: Примеры фраз для разных состояний.
            *   `mita_history.txt`: История персонажа.
        *   **`Events/`**: Тексты для специфических игровых событий.
            *   `SecretExposed.txt`: Текст, когда "секрет" Миты раскрыт.
        *   **`Main/`**: Основные текстовые блоки, определяющие личность и поведение.
            *   `common.txt`: Общие инструкции.
            *   `main.txt` (обычная Мита), `mainCrazy.txt` (безумная Мита), `mainPlaying.txt` (играющая Мита).
            *   `player.txt`: Описание игрока.
        *   **`Scripts/`**: DSL-скрипты, реализующие логику.
            *   `personality_selector.script`: Выбирает один из файлов `Main/main*.txt` на основе переменных `attitude`, `secretExposed` и др., используя `IF ... RETURN LOAD ...`.
            *   `get_available_animations.script`: Генерирует список анимаций на основе `attitude`.
            *   Другие скрипты для генерации или выбора специфической информации.
        *   **`States/`**: Тексты для различных состояний конечного автомата (FSM).
            *   `hello.txt`: Приветственное сообщение.
        *   **`Structural/`**: Файлы, описывающие структуру ответа или другие мета-инструкции.
            *   `response_structure.txt`: Формат ответа, который должна генерировать Мита.

Эта структура позволяет логически разделить компоненты промпта: статический текст, примеры, скрипты логики, описания состояний и т.д.

### VI. Теги: `{{SYS_INFO}}` и Другие

Теги предназначены для вставки информации, которая не генерируется самим DSL, а предоставляется внешней системой.

*   **`{{SYS_INFO}}`**:
    *   **Назначение:** Для вставки системной информации, такой как глобальные правила, текущий контекст диалога, мета-инструкции от "мастера игры" и т.п.
    *   **Текущий статус в редакторе:** При нажатии кнопки "Скомпоновать промпт" в редакторе, вместо реальной системной информации вставляется **фиксированный тестовый пример** (массив строк: `["[SYS_INFO]: Пример Системного Сообщения.", "[SYS_INFO]_2 Пример второго системного сообщения."]` ). Это позволяет проверить, что тег корректно обрабатывается и присутствует в шаблоне.
    *   **Использование:** Предполагается, что `main_template.txt` или один из его подключаемых файлов будет содержать тег `{{SYS_INFO}}` в соответствующем месте, чтобы реальная система могла его заполнить. Редактор выведет предупреждение, если этот обязательный тег отсутствует.
*   **Другие теги:** Можно определять и другие теги (например, `{{PLAYER_NAME}}`, `{{CURRENT_LOCATION}}`), но их заполнение должно быть реализовано в Python-коде, который использует DSL-движок. В данный момент, при тестировании через кнопку "Скомпоновать промпт" в редакторе, только `{{SYS_INFO}}` имеет примерное значение. (Примечание: переменные персонажа типа `player_name` из панели "Параметры DSL" обрабатываются через механизм переменных DSL, а не через систему тегов `{{...}}`).

### VII. Переменные Персонажа и Панель "Параметры DSL"

В редакторе промптов справа находится панель "Параметры DSL".

*   **Назначение:** Позволяет задавать начальные значения переменных для **выбранного персонажа** перед тем, как нажать кнопку "Скомпоновать промпт". Это полезно для тестирования того, как DSL-скрипты и текстовые шаблоны реагируют на разные значения переменных.
*   **Формат:** Каждая переменная и ее значение указываются на новой строке:
    ```
    player_name=Тестер
    attitude=100
    secretExposed=false
    current_fsm_state=Hello
    ```
*   **Типы значений:**
    *   Строки: `player_name='Иван Грозный'` или `player_name="Марья Искусница"`
    *   Числа: `attitude=50`
    *   Булевы значения: `secretExposed=true` или `secretExposed=FALSE` (регистр не важен для `true`/`false`)
*   **Предопределенные переменные:**
    *   `SYSTEM_DATETIME`: Автоматически устанавливается DSL-движком в формат "ГГГГ Месяц ДД (День недели) ЧЧ:ММ" (например, "2024 Март 15 (Пятница) 10:30"). Вы можете использовать ее в своих скриптах.
        *   Пример из `Prompts\Crazy\Scripts\context_info.script`: `SET formatted_time = SYSTEM_DATETIME`.

### VIII. Отладка и Рекомендации

1.  **Команда `LOG`:** Ваш основной инструмент для отладки `.script` файлов. Выводите значения переменных, сообщения о входе в определенные ветки `IF` и т.д.
    ```dsl
    LOG "Entering IF block for high attitude. Current attitude: " + attitude
    ```
2.  **Панель "Логи" в Редакторе:** Отображает сообщения от `LOG`, а также ошибки выполнения DSL и другую служебную информацию.
3.  **Файл `Logs/dsl_execution.log`:** Более подробный лог, сохраняющийся в корневой папке проекта.
4.  **Модульность:** Разбивайте сложные промпты на мелкие, логически завершенные `.txt` и `.script` файлы. Это упрощает понимание, отладку и переиспользование.
5.  **Общие Ресурсы:** Используйте папки `_CommonPrompts/` и `_CommonScripts/` для файлов, которые могут понадобиться нескольким персонажам.
6.  **Именование:** Давайте файлам и переменным осмысленные имена.
7.  **Тестирование:** Регулярно используйте кнопку "Скомпоновать промпт", изменяя значения переменных на панели "Параметры DSL", чтобы проверять все ветки логики.

Следуя этому руководству, вы сможете эффективно использовать DSL для создания сложных и интересных промптов для ваших персонажей.